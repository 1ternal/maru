** Middleware
*** Use Middleware
A middleware should at least define one of these three function: =prepare/1=, =call/2= and =finish/1=.
#+BEGIN_SRC elixir
defmodule PrepareMiddleware do
  use Lazymaru.Middleware

  def prepare(conn) do
     user = BAISIC_AUTH(conn) || nil
     assign(:current_user, user)
     conn
  end
end

defmodule ExceptionMiddleware do
  use Lazymaru.Middleware

  def call(conn, app) do
    try do
      app.(conn)
    rescue
      e in [LazyException.InvalidFormatter] ->
        e.message |> text(500)
      FunctionClauseError ->
        "Not Found" |> text(404)
    end
  end
end
#+END_SRC
